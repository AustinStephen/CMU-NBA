---
title: "<span style='font-size: 70px'>Modeling Player Fatigue in the NBA </style>"
author: "<span style='font-size: 35px'>Austin Stephen, Matthew Yep and Grace Fain </style>"
date: "<span style='font-size: 35px'> 7/30/2021 </style>"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    nature: 
      countIncrementalSlides: false
      slideNumberFormat: "%current%"
---


```{r  xaringan-themer, setup, include=FALSE}
library(xaringanthemer)
knitr::opts_chunk$set(
  echo = FALSE,
  cache = TRUE,
  message = FALSE,
  warning = FALSE
  )
library(readr)
library(dplyr)
library(tidyverse)
library(gt)
library(xaringanthemer)
library(teamcolors)
library(usmap)
library(ggplot2)
library(maps)
library(mapdata)
library(airball)
library(gridExtra)
library(png)
library(grid)

tracking_by_player_season_daily_2019_20 <- read_csv("data/in_game_distance_data/tracking_by_player_season_daily_2019_20.csv")

```

```{r xaringan-themer, include=FALSE, warning=FALSE }

visitors <- read_csv("./matthew_data/visitors.csv")
data1415 <- read_csv("./matthew_data/regseason1415.csv")
datos <- read_csv("./matthew_data/map1415data.csv")

style_mono_accent(base_color = "#374052",
  white_color = "#e6e6e6",
  background_color = "#b8b8b8",
  base_font_size = "28px"
  )
```

## Why Fatigue?  

<span> 1.</span> Player Performance

???
The literature is very clear that insufficient rest worsens athlete preformance. 

Edwards et al The National Center for Biotechnology Information
"Early identification and subsequent management of fatigue may prevent detrimental 
physical and physiological adaptations often associated with injury and enhance 
athletic performance and player availability"

--

<span> 2. </span> Schedule Fairness  

--


INSERT GAPHIC AND DISTANCE TRAVELED B2B DISCUSSION

---

## Findings  

1. In-game distance measures suggest players achieve a high degree of recovery 
between games.

???
These might get changed last minute.

--

2. Offer an improved model for team strength

--

3. A subset of schedule induced factors impact game outcomes 

--

4. Impact of travel has decreased over time 


---

## What is Fatigue?

- Cannot use direct measures  

???

More concrete on fatigue: 
Edwards et al. The National Center for Biotechnology Information
"the decline in objective performance measures derived from the capacity 
of the nervous system and contractile properties of muscles over time"


In a perfect world we would directly measure an NBA players internal homeostasis
either with hematological techniques or heart rate sensors. 
However, players cannot wear heart rate monitors or tracking equipment in 
games and we certainly don't have data about in/post-game blood samples 
for hematological analysis so we need a proxies to measure how 
fatigued a player was by in game events.

--

- Identify events that fatigue players

---

## Fatigue Inducing Events

1. In-game events  
  - ex. distance run or speed

2. Between game events  
  - ex. Length of flight or rest since last game
???
For the purposes of our project we define two types of fatigue inducing events.

---

## In-Game Distance  

```{r}
 tracking_player <- read_csv(
   "data/in_game_distance_data/tracking_by_player_season_daily_2018_19.csv")


 tracking_player %>%
   select(c("player_name","date","min", "dist_miles","dist_miles_off", "dist_miles_def",
            "avg_speed","avg_speed_off","avg_speed_def")) %>%
   rename("Name" = player_name,
          "Distance (mi)" = dist_miles,
          "Distance Offense"  = dist_miles_off,
          "Distance Defense" = dist_miles_def,
          "Speed (mph)" = avg_speed,
          "Speed Offense" = avg_speed_off,
          "Speed Defense" = avg_speed_def,
          "Date" = date,
          "Min" = min) %>%
   slice(1:4) %>%
   gt() %>%
   tab_header(
    title = md("**Distance By Player Individual Games**")
  ) %>%
  tab_source_note(md("Data courtesy of nba.com and Second Spectrum")) %>%
  opt_table_outline( style = "solid", width = px(5), color = "#001747")%>%
  tab_options(table.width = pct(80))
```

???
3 important things:  
Gen by computer vision  
Game by game  
Player level  

---

## In-Game Distance 

- W = F \* d,  $\Delta$W = $\Delta$d

???
We were particularly excited by the prospect of using this in-game distance data 
because it holds the potential to be a very strong measure of athlete exertion. 
We know from kinematics the work it requires to preform an action is 
defined as Force * distance. The force to move an object of constant mass is also
as constant, therefore if we assume a players mass is constant over a season,
the changes in distance for a game capturing all of their delta in work.
In other words, work is agnostic to the time and cardinality of the force players
use to move their bodies. This means despite being a very high level view of the
game it is capturing a very high amount information about plaeyer exertion.
We felt this gave our exploration of players distance relative to their baseline 
really strong theoretical footing. This is why when we use player data it is 
relative to player baselines.  

We saw 2 steps to making a robust analysis of this data.
1. Understand the relationship in-game distance has with game outcomes
2. Identify factors that can inhibit distance (ex, fatigue) and in turn 
    influence game outcomes

--

- 2 steps:

--

   <span> 1. </span> Identify how in-game distance relates to game outcomes <br>   
    
--
   <span> 2.</span> Identify factors that can inhibit in-game distance  

---

## In-Game Distance 

- More distance does not equal better performance

???
Hypothesized more distance meant more effort so ideally better performance.

Explain axis and data is 20k observations  

No correlation between fg percentage and distance a team travels.

--

- p-value 0.402

```{r fig.height =4, include =TRUE}
gbg_player_w_distance <- read_csv(
 "./data/in_game_distance_data/in_game_dist_box_join.csv") %>% filter(min >12)

gbg_player_w_distance %>% 
  ggplot(aes(x=diff_from_sn_avg_speed, y= diff_from_sn_avg_fgpct)) + 
  geom_point(color = "brown", alpha = .1)+
  geom_abline(intercept = 110.614, slope = -7.617, color = "darkred")+
  theme_bw()+ 
  geom_smooth(method = "lm", se = FALSE) +
  labs( title = "FG % Difference From Season Average",
        x = "Distance in Miles Min Adjusted",
        y = "FG Percent")+
  theme(panel.background = element_rect(fill ="burlywood"),
        panel.grid.major = element_blank(),
        plot.title = element_text(size = 20),
        text = element_text(size = 14)
        )
# summary(lm(diff_from_sn_avg_speed ~ diff_from_sn_avg_fgpct, data =gbg_player_w_distance))

```

---

## In-Game Distance 

- More distance does not equal better performance  

???
Here you are looking at the same plot for turnovers, no relationship. I'm grossly 
simpliying the exploration that went into these factors but we were able to 
dispell any relationships. 

--
- p-value 0.498  

```{r fig.height = 4, include = TRUE}

gbg_player_w_distance <- read_csv(
 "./data/in_game_distance_data/in_game_dist_box_join.csv") %>% filter(min >12)

gbg_player_w_distance %>% 
  ggplot(aes(x=diff_from_sn_avg_speed, y= diff_from_sn_avg_tov)) + 
  geom_point(color = "brown", alpha =.05)+
  geom_abline(intercept = 110.614, slope = -7.617, color = "darkred")+
  theme_bw()+ 
  geom_smooth(method = "lm", se = FALSE) +
  labs( title = "Turnovers Difference From Season Average",
        x = "Distance in Miles Min Adjusted",
        y = "Turnovers")+
  theme(panel.background = element_rect(fill ="burlywood"),
        panel.grid.major = element_blank(),
        plot.title = element_text(size = 20),
        text = element_text(size = 14)
        )+
   scale_x_continuous(limits = c(-.75,1))
#summary(lm(diff_from_sn_avg_tov ~ diff_from_sn_avg_speed, data =gbg_player_w_distance))

```

---


## In-Game Distance 

- Increase volume does not provide evidence of a refractory period  
<br>

```{r fig.height=4, include = TRUE}
gbg_player_w_distance <- read_csv(
  "./data/in_game_distance_data/in_game_dist_box_join.csv")

layer_Window_speed_daily_2014_15 <- read_csv(
  "./data/in_game_distance_data/player_Window_speed_daily_2014_15.csv") %>%
  select("player_id","date","speed_5dayWindow","speed_7dayWindow")

layer_Window_speed_daily_2014_15$date <- as.Date(
  layer_Window_speed_daily_2014_15$date, "%m/%d/%Y")

gbg_player_w_distance <- merge(x = gbg_player_w_distance,
                               y = layer_Window_speed_daily_2014_15,
                               by.x =  c("player_id","date" ),
                               by.y = c("player_id","date" ))

## windows of time analysis 
player_Window_dist_daily_2014_15 <- read_csv(
  "./data/in_game_distance_data/player_Window_dist_daily_2014_15.csv")%>%
  select("player_id","date","dist_5dayWindow","dist_3dayWindow","dist_7dayWindow",
         "dist_10dayWindow")
player_Window_dist_daily_2014_15$date <- as.Date(
  player_Window_dist_daily_2014_15$date, "%m/%d/%Y")

## removing all instances where player played less than 15 seconds because 
## these are just not insightful instances 
gbg_player_w_distance <- gbg_player_w_distance %>% filter(min > .25)


## window
gbg_player_w_distance <- merge(x = gbg_player_w_distance,
                               y = player_Window_dist_daily_2014_15,
                               by.x =  c("player_id","date" ),
                               by.y = c("player_id","date" ))

## Adding a difference from mean 5 day window
gbg_player_w_distance <- gbg_player_w_distance %>%
  group_by(player_id) %>%
  mutate(sn_avg_wind_3_dist = mean(dist_3dayWindow)) %>%
  mutate(diff_sn_avg_wind_3_dist = dist_3dayWindow - sn_avg_wind_3_dist ) %>%
  mutate(sn_avg_wind_5_dist = mean(dist_5dayWindow)) %>%
  mutate(diff_sn_avg_wind_5_dist = dist_5dayWindow - sn_avg_wind_5_dist ) %>%
  mutate(sn_avg_wind_7_dist = mean(dist_7dayWindow)) %>%
  mutate(diff_sn_avg_wind_7_dist = dist_7dayWindow - sn_avg_wind_7_dist ) %>%
  mutate(sn_avg_wind_10_dist = mean(dist_10dayWindow)) %>%
  mutate(diff_sn_avg_wind_10_dist = dist_10dayWindow - sn_avg_wind_10_dist ) %>%
  mutate(sn_avg_wind_5_speed = mean(speed_5dayWindow)) %>%
  mutate(diff_sn_avg_wind_5_speed = speed_5dayWindow - sn_avg_wind_5_speed ) %>%
  mutate(sn_avg_wind_7_speed = mean(speed_7dayWindow)) %>%
  mutate(diff_sn_avg_wind_7_speed = speed_7dayWindow - sn_avg_wind_7_speed )

gbg_player_w_distance %>%
ggplot(aes(x = diff_sn_avg_wind_5_dist,y = diff_from_sn_avg_dist))+
  geom_point(alpha = .05, color = "brown")+
  geom_smooth(method="lm")+ 
  labs(y = "Distance in Game",
       x = "Distance Traveled in 5 Prior Days",
       title = "Distance Deviation From Season Average")+
  theme(panel.background = element_rect(fill ="burlywood"),
        panel.grid.major = element_blank(),
        plot.title = element_text(size = 20),
        text = element_text(size = 14)
        )
```

???

Moving to the second part of our analysis of in-game distance we are looking to 
observe players fatiguing over time.

We hypothesized a players who's workload deviated from their season average in previous 
days would exhibit a refractory period due to fatigue. However, we again found 
compelling evidence this is not the case.
It actually appears the opposite is true, the greater workload in preceding days
indicated in the observation game the athlete was likely to again take on 
a higher workload.

Hypothesized this is caused by players who are playing well get left in the
game longer.
---

## In-Game Distance 

- Time adjustment suggests fatigue is too small to measure

- Results consistent across 3, 5, 7 and 10 day windows

```{r fig.height = 4}
gbg_player_w_distance %>%
ggplot(aes(x = diff_sn_avg_wind_5_speed,y = diff_from_sn_avg_speed))+
  geom_point(alpha = .05, color = "brown")+
  geom_smooth(method="lm")+ 
  labs(y = "Current game",
       x = "Last 5 days",
       title = "Min Adjusted Distance Deviation From Season Average")+
  theme(panel.background = element_rect(fill ="burlywood"),
        panel.grid.major = element_blank(),
        plot.title = element_text(size = 20),
        text = element_text(size = 14))+
  scale_y_continuous(limits = c(-3.5, 3.5))
        

```


---

## In-Game Distance

- How does player distance relate to game outcomes
GRACE ADD your stuff

---

## In-Game Distance 

- How does player distance relate to game outcomes
GRACE ADD your stuff

---

## What does this mean?

- Basketball is complex  

- Evidence indicating teams do a good job making sure their players are recovered.

- 

???
1. Basketball is composed of complex interaction of skill sets and simply working
harder does necessarily yield better results. While tracking data sounds 
exciting without being more closely tied to other in-game events it offers 
little utility by way of player performance.

2. One of the biggest trends in basketball commentary is players get tired 
from playing too many games and as a result the quality of game 
decreases. However, we offer compelling evidence a players workload over the 
their previous games does not influence their performance in future games.

Based on these results, we wouldn't be surprised if often people are often searching 
to explain why a player did worse in a game when the truth is there may be
nothing more than random variations in performance. Aka just because your star player 
had a bad night it does not mean fatigue was necessarily to blame.

That said, we aren't trying to tell you players don't ever get tired because that's 
obviously not the case. Rather we are saying it appears the complexity of basketball
and the techniques used by teams to ensure players are ready to play are more
sophisticated than can be captured by measuring the players work.

---

## Between Game Events 
 MATTHEW INTRODUCE DATA

---

## Between Game Events 

GRACE T-TEST HERE


---

## Between Game Events
- Disparity in team strength 

- Remove variance in response associated with 

?? 
while t-tests offer a great way to look for relationships they have a high 
risk for colinearlity with a latent variable. For example, in the time period
we observed the Golden State Warriors had a sequence of 
historically strong seasons and they also make up 1/5 of the West coast teams, 
which could have introduced latent effects associated with their travel.



---

## Modeling for Team Strength

1. __Constrained:__ Limited to the information available to a team when they would 
have played the game.

2. __Unconstrained:__ All available information about the team not
incorporated into the response is used to break down what contributed to the 
outcome of a given game.


???
2 concepts for modeling team strength. 

We chose to prioritize the second model because essentially what it would allow us
to do is decompose the response into its causes and we were interested in identifying
what effect between game factors had on game outcome in the absence of as much of
the team strength as possible.

---

## Modeling Team Strength 

- Net season rating is very powerful

```{r}

```

---
## Mesuring the Impact of Between Game Events 

MATTHEW SHOW OUR COEFFCICENTS 

---
## Mesuring the Impact of Between Game Events 

MATTHEW SHOW OUR COEFFCICENTS OVER THE SEASONS

--
How Can Teams Use This Information?

--
Future Work




