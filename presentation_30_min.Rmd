---
title: "<span style='font-size: 70px'>Modeling Player Fatigue in the NBA </style>"
author: "<span style='font-size: 35px'>Austin Stephen, Matthew Yep and Grace Fain </style>"
date: "<span style='font-size: 35px'> 7/30/2021 </style>"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    nature: 
      countIncrementalSlides: false
      slideNumberFormat: "%current%"
---


```{r  xaringan-themer, setup, include=FALSE}
library(xaringanthemer)
knitr::opts_chunk$set(
  echo = FALSE,
  cache = TRUE,
  message = FALSE,
  warning = FALSE
  )
library(readr)
library(dplyr)
library(tidyverse)
library(gt)
library(xaringanthemer)
library(teamcolors)
library(usmap)
library(ggplot2)
library(maps)
library(mapdata)
library(airball)
library(gridExtra)
library(png)
library(grid)
library(ggimage)
library(gt)
```

```{r xaringan-themer, include=FALSE, warning=FALSE }
coords_and_distance <- read_csv("./matthew_data/coords_and_distance.csv")
travel1415 <- read_csv("./matthew_data/travel1415.csv")
together_net_Rating_allWindows <- read_csv("./matthew_data/austin_everything.csv")
check <- read_csv("./matthew_data/kawhi.csv")

style_mono_accent(base_color = "#374052",
  white_color = "#e6e6e6",
  background_color = "#b8b8b8",
  base_font_size = "28px"
  )
```

## Why Fatigue?  

<span> 1.</span> Player Performance

???
The literature is very clear that insufficient rest worsens althlete preformance. 

"Early identification and subsequent management of fatigue may prevent detrimental 
physical and physiological adaptations often associated with injury and enhance 
athletic performance and player availability"
Edwards et al The National Center for Biotechnology Information

--

<span> 2. </span> Schedule Fairness  

--


INSERT GAPHIC AND DISTANCE TRAVELED B2B DISCUSSION

---
###North-eastern teams travel substantially less than other teams
<font size="4.5"> The Blazers traveled over 62,000 miles in the 14-15 season, the Cavs only traveled 35,000 </font>
```{r Map, echo = FALSE, fig.height= 7, fig.width=12}
states <- map_data("state")
ggplot() + geom_polygon(data = states, aes(x=long, y = lat, fill = region, group = group), fill = "white", color = "gray") + 
  coord_fixed(1.3) + 
  geom_image(data = coords_and_distance, aes(x = Longitude, y = Latitude, image = logo, size = I(img_size))) +
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
        axis.text.y=element_blank(), axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.background=element_blank(),panel.border=element_blank(),panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),plot.background=element_blank(),
        legend.position = "bottom")
```

---
### The Cavaliers also cross far less timezones than the coastal teams
```{r Flight Paths, echo = FALSE, fig.height = 7, fig.width=12}
nba_travel_plot(data = travel1415,
                season = 2015,
                team = c("Portland Trail Blazers","Denver Nuggets", "Cleveland Cavaliers", "Boston Celtics"),
                city_color = "yellow",
                plot_background_fill = "black",
                land_color = "gray",
                caption_color = "lightblue",
                ncolumns = 2)

```

---

## Findings  

1. In-game distance measures suggest players achieve a high degree of recovery 
between games.

--

2. Offer an improved model for team strength

--

3. A subset of schedule induced factors impact game outcomes 

--

4. Impact of travel has decreased over time 

  

???
These might get changed last minute.

---

## What is Fatigue?

- Cannot use direct measures  

???

More concrete on fatigue: 
"the decline in objective performance measures derived from the capacity 
of the nervous system and contractile properties of muscles over time"
Edwards et al. The National Center for Biotechnology Information

In a perfect world we would directly measure an NBA players internal homeostasis
either with hematological techniques or with sensors that measure heart rate. 
However, players cannot wear heart rate monitors or tracking equipment in 
games and we certainly don't have data about in/post-game blood samples 
so we need a proxy to measure how fatigued a player was by in game events.

--

- Identify events that fatigue players

---

## Fatigue Inducing Events

1. In-game events  
  - ex. distance run or speed
  
--

2. Between game events  
  - ex. Length of flight or rest since last game

???
For the purposes of our project we define two types of fatigue inducing events.


---

## In-Game Distance  

```{r}
 tracking_player <- read_csv(
   "data/in_game_distance_data/tracking_by_player_season_daily_2018_19.csv")


 tracking_player %>%
   select(c("player_name","date","min", "dist_miles","dist_miles_off", "dist_miles_def",
            "avg_speed","avg_speed_off","avg_speed_def")) %>%
   rename("Name" = player_name,
          "Distance (mi)" = dist_miles,
          "Distance Offense"  = dist_miles_off,
          "Distance Defense" = dist_miles_def,
          "Speed (mph)" = avg_speed,
          "Speed Offense" = avg_speed_off,
          "Speed Defense" = avg_speed_def,
          "Date" = date,
          "Min" = min) %>%
   slice(1:4) %>%
   gt() %>%
   tab_header(
    title = md("**Distance By Player Individual Games**")
  ) %>%
  tab_source_note(md("Data courtesy of nba.com and Second Spectrum")) %>%
  opt_table_outline( style = "solid", width = px(5), color = "#001747")%>%
  tab_options(table.width = pct(80))
```

???
3 important things
Gen by computer vision  
Game by game  
Player level  

---

## In-Game Distance 

- W = F \* d = (m \* a) \* d, $\Delta$W = $\Delta$d

--

- 2 steps:

--

   <span> 1. </span> Understand the relationship in-game distance has with game 
   outcomes <br>   
    
--
   <span> 2.</span> Identify factors that can inhibit in-game distance 
   (ex, fatigue) and in turn influence game outcomes  


???
We were excited to be the first people in the public space that we are aware of
to try and model player fatigue using this in game distance data.

Second we know from physics the work it requires to preform an action is
the (mass * acceleration) * distance. You'll notice everytime we discuss distance
this is baselined to a players season average meaning mass and acceleration are 
essentially constants. Giving us an incredibly powerful tool for examining a playersexertion in that game relative to the players other games.


We saw 2 steps to making a robust analysis of this data.
1. Understand the relationship in-game distance has with game outcomes
2. Identify factors that can inhibit distance (ex, fatigue) and in turn 
    influence game outcomes

---

## In-Game Distance 

- More distance does not equal better performance

--

- p-value .281

```{r}
## team tracking distance 
team_tracking <- read.csv(
  "./data/in_game_distance_data/tracking_by_team_season_summaries_2013_to_20.csv")

## Team season box scores
season_box_scores_team_2010_20 <- read.csv(
  "./data/box_scores/season_box_scores_team_2010_20.csv")

## Joining team box scores to season distance data 
team_tracking_w_box_scsores <- merge(team_tracking,
                                    season_box_scores_team_2010_20,
                                    by.x = c("team_id","season"), 
                                    by.y = c("team_id","season")) %>%
  select(-c("team_name.y","gp.y","w.y","l.y", "min1")) %>%
  rename( "w" = w.x, "gp" = "gp.x", "l" = l.x)

team_tracking_w_box_scsores %>% 
  ggplot(aes(x=dist_miles_off, y= fg3_pct)) + 
  geom_point()+
  geom_abline(intercept = 110.614, slope = -7.617, color = "darkred")+
  theme_bw()+ 
  geom_smooth(method = "lm", se = FALSE) +
  labs( title = "2013 to 2020 three point shooting percentage and offensive distance")

```
???
Step 1:
The intuition many viewers of basketball and us going into the project was players
get tired and then run less and as a result their performance suffers. This appears
to be a gross simplification of player performance.

---

## In-Game Distance 

- More distance does not equal better performance

--

- p-value 0.836

```{r}
team_tracking_w_box_scsores %>% 
  ggplot(aes(x=dist_miles_off, y= fg_pct)) + 
  geom_point()+
  geom_abline(intercept = 110.614, slope = -7.617, color = "darkred")+
  theme_bw()+ 
  geom_smooth(method = "lm", se = FALSE) +
  labs( title = "2013 to 2020 three point shooting percentage and offensive distance")

```
???
Step 1:
Same thing here for fg percentage. In general, all of the metrics we explored 
found no relationship between he distance the players traveled and any positive 
or negative game measure. Without a few complicated and explainable caveats.

---

## In-Game Distance 

- Increase volume does not cause a refractory period  
<br>

```{r fig.height=4}
gbg_player_w_distance <- read_csv(
  "./data/in_game_distance_data/in_game_dist_box_join.csv")

layer_Window_speed_daily_2014_15 <- read_csv(
  "./data/in_game_distance_data/player_Window_speed_daily_2014_15.csv") %>%
  select("player_id","date","speed_5dayWindow","speed_7dayWindow")

layer_Window_speed_daily_2014_15$date <- as.Date(
  layer_Window_speed_daily_2014_15$date, "%m/%d/%Y")

gbg_player_w_distance <- merge(x = gbg_player_w_distance,
                               y = layer_Window_speed_daily_2014_15,
                               by.x =  c("player_id","date" ),
                               by.y = c("player_id","date" ))

## windows of time analysis 
player_Window_dist_daily_2014_15 <- read_csv(
  "./data/in_game_distance_data/player_Window_dist_daily_2014_15.csv")%>%
  select("player_id","date","dist_5dayWindow","dist_3dayWindow","dist_7dayWindow",
         "dist_10dayWindow")
player_Window_dist_daily_2014_15$date <- as.Date(
  player_Window_dist_daily_2014_15$date, "%m/%d/%Y")

## removing all instances where player played less than 15 seconds because 
## these are just not insightful instances 
gbg_player_w_distance <- gbg_player_w_distance %>% filter(min > .25)


## window
gbg_player_w_distance <- merge(x = gbg_player_w_distance,
                               y = player_Window_dist_daily_2014_15,
                               by.x =  c("player_id","date" ),
                               by.y = c("player_id","date" ))

## Adding a difference from mean 5 day window
gbg_player_w_distance <- gbg_player_w_distance %>%
  group_by(player_id) %>%
  mutate(sn_avg_wind_3_dist = mean(dist_3dayWindow)) %>%
  mutate(diff_sn_avg_wind_3_dist = dist_3dayWindow - sn_avg_wind_3_dist ) %>%
  mutate(sn_avg_wind_5_dist = mean(dist_5dayWindow)) %>%
  mutate(diff_sn_avg_wind_5_dist = dist_5dayWindow - sn_avg_wind_5_dist ) %>%
  mutate(sn_avg_wind_7_dist = mean(dist_7dayWindow)) %>%
  mutate(diff_sn_avg_wind_7_dist = dist_7dayWindow - sn_avg_wind_7_dist ) %>%
  mutate(sn_avg_wind_10_dist = mean(dist_10dayWindow)) %>%
  mutate(diff_sn_avg_wind_10_dist = dist_10dayWindow - sn_avg_wind_10_dist ) %>%
  mutate(sn_avg_wind_5_speed = mean(speed_5dayWindow)) %>%
  mutate(diff_sn_avg_wind_5_speed = speed_5dayWindow - sn_avg_wind_5_speed ) %>%
  mutate(sn_avg_wind_7_speed = mean(speed_7dayWindow)) %>%
  mutate(diff_sn_avg_wind_7_speed = speed_7dayWindow - sn_avg_wind_7_speed )

gbg_player_w_distance %>%
ggplot(aes(x = diff_sn_avg_wind_5_dist,y = diff_from_sn_avg_dist))+
  geom_point(alpha = .1)+
  geom_smooth(method="lm")+ 
  labs(y = "distance in game",
       x = "distance traveled in 5 prior days",
       title = "Distance Deviation From Season Average")+
  theme(panel.background = element_rect(fill ="burlywood"),
        panel.grid.major = element_blank(),
        plot.title = element_text(size = 20),
        text = element_text(size = 14)
        )
```

???
Step 2: 
Despite not finding a relationship with distance and game outcomes, it is entirely 
possible we could still measure players fatiguing over a season.

We entered his with analysis players with the hypothesis players who played 
more in previous games will be unable to continue that 
level of performance because the refractory period. This motivates resting 
schedules, however, we again found compelling evidence this is not the case. 
In fact, we see the opposite

Hypothesized this is caused by players who are playing well get left in the
game longer.
---

## In-Game Distance 

- Suggests refractory period is too small to measure

- Results consistent across prior 3, 7 and 10 days  
<br>

```{r fig.height = 4}
gbg_player_w_distance %>%
ggplot(aes(x = diff_sn_avg_wind_5_speed,y = diff_from_sn_avg_speed))+
  geom_point(alpha = .05)+
  geom_smooth(method="lm")+ 
  labs(y = "Current game",
       x = "Last 5 days",
       title = "Play Time Adjusted Distance Deviation From Season Average")+
  theme(panel.background = element_rect(fill ="burlywood"),
        panel.grid.major = element_blank(),
        plot.title = element_text(size = 20),
        text = element_text(size = 14))

```


---

## In-Game Distance

- How does player distance relate to game outcomes
GRACE ADD your stuff

---

## In-Game Distance 

- How does player distance relate to game outcomes
GRACE ADD your stuff

---

## Why do you care about these null results?

- Basketball is complex  

- Evidence suggesting teams do a good job ensuring their players prefromance 
does not decline due to workload.  

???
1. Basketball is composed of complex interaction of skill sets and while
tracking data sounds exciting without being more closely tied to other in-game
events it offers little information about player performance.

2. One of the biggest trends in basketball commentary is players get tired 
from playing too many games and as a result the quality of game 
decreases. However, we offer compelling evidence a players workload over the 
their previous games does not influence their performance in future games.

Base on these results, we wouldn't be surprised if often people searching 
to explain why a player did worse in a game when they played so well in the
previous game is not a matter of fatigue but rather random variations in 
performance or simply regression to the mean.

---
### Load Management is an effective strategy for Kawhi in the short run
```{r Kawhi Case Study, echo = FALSE, fig.height = 6.5, fig.width = 12}
check$player_rest <- ifelse(check$player_rest == 15, 4, check$player_rest)
check$team_rest <- ifelse(check$team_rest == 15, 4, check$team_rest)

check <- check %>% 
  mutate(extra_rest = player_rest - team_rest) 

x <- check$extra_rest
check$type_of_rest <- case_when(
  x >= 14 ~ "extended injury rest",
  x < 14 & x >= 4 ~ "minor injury rest", 
  x < 4 & x > 1 ~ "couple extra days rest",
  x == 1 ~ "sit out one game",
  x ==0 ~ "no load manage",
)

check$type_of_rest <- ordered(check$type_of_rest, levels = c("extended injury rest",
                                                             "minor injury rest",
                                                             "couple extra days rest",
                                                             "sit out one game",
                                                             "no load manage"))
nums <- c(1:524)
check$count <- nums

ggplot(data = filter(check, ratioPIE < 0.6)) +
  geom_point(aes(x = count, y = ratioPIE, color = type_of_rest), alpha = 0.7) +
  geom_hline(yintercept = 0.1 , linetype = "dashed") +
  geom_vline(xintercept = 408, linetype = "dashed", color = "gray") +
  geom_vline(xintercept = 468, linetype = "dashed", color = "gray") +
  scale_color_manual(values=c("red", "yellow", "purple", "blue", "gray")) + 
  labs(title = "Kawhi's PIE in Games Following Different Periods of  Rest") + 
  ylab("Player Impact Estimate") +
  xlab("Game Date") +
  theme(axis.text.x=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        axis.ticks=element_blank(),
        legend.position = "bottom")
```
---

###Taking a look at cross game fatigue
``` {r Cross Game Data, echo = FALSE, fig.height = 6.5, fig.width = 12}
together_net_Rating_allWindows <- together_net_Rating_allWindows %>%
  select(-c(fgm:opp_blk)) %>%
  select(-c(fgm_diff:blk_diff))

together_net_Rating_allWindows <- together_net_Rating_allWindows %>%
  mutate(distance_diff = Distance - opp_distance) %>%
  mutate(windowed_distance_diff = dist_30dayWindow - opp_dist_30dayWindow) %>%
  mutate(distance_advantage = (distance_diff < 0)) %>%
  mutate(windowed_distance_advantage = (windowed_distance_diff) < 0)

together_net_Rating_allWindows %>%
  select(c("Date", "visitor", "Opponent", "game_net_rating", "distance_diff","rest_diff","shift", 
           "b2b_2nd", , "net_rating_diff", )) %>%
  slice(1, 2386, 4200, 8642) %>%
   gt() %>%
   tab_header(
    title = md("**Travel, Schedule and Density Data**")
  ) %>%
  tab_source_note(md("Data courtesy of Jose Fernandez (airball) and Patrick Chodowski (NBAr)")) %>%
  opt_table_outline( style = "solid", width = px(5), color = "#666666") %>%
  tab_options(table.width = pct(100))
```

???
Transition by saying in game events are only half the picture.

---

## Between Game Events 

GRACE T-TEST HERE


---

## Between Game Events

AUSTIN INTRODUCE THE NEED TO CONTROL FOR TEAM STRENGTH 

---

## Modeling for Team Strength

AUSTIN INTRODUCE 2 CONCEPTS FOR MODELS AND WHY WE FOCUSED ON TYPE 2

---

## Modeling Team Strength 

AUSTIN EXPLAIN OUR MODEL

---

## Modeling Team Strength 

AUSTIN SHOW OUR MODELS IMPORVED RESULTS

---
### Many of our travel and scheduling metrics had insignificant effects on game net rating
* Distance traveled
* Windowed distance traveled
* Distance traveled difference
* Flight duration
* Timezone shift by -2, -1, 1, 2, and 3 hours
* 2nd leg of a back to back
* Tipoff time 
  + West coast teams playing in the morning EST
  + East coast teams playing at night PST

---

### Rest, a 3 hour shfit back, and three in four proved to be significant
 <font size="5"> $gameNetRating$ = $\beta_0$ + $\beta_1$ $netRatingDiff$ + $\beta_2$ $restDiff$ + $\beta_3$ $travel3HoursBack$ + $\beta_4$ $third GameFourDays$ </font>
```{r Linear Model, echo=FALSE, fig.align = "center", fig.height = 5.5, fig.width = 12}
summ <- summary(lm(game_net_rating ~ net_rating_diff+ three_in_four 
             + travel_3_hours_back + rest_diff,
           data = together_net_Rating_allWindows))

coefficients <- c("intercept", "net_rating_diff",
                  "rest_diff", "three_in_four","travel_3_hours_back")

coefficients <- ordered(coefficients, levels = c("intercept","net_rating_diff",
                                                 "rest_diff","travel_3_hours_back", "three_in_four"))
betas <- as.numeric(summ$coefficients[,1])
standard_errors <- as.numeric(summ$coefficients[,2])
p_values <- as.numeric(summ$coefficients[,4])
p <- sprintf("p= %s", p_values)

table <- data.frame(coefficients, betas, standard_errors, p)

library(ggrepel)

ggplot(data = table, aes(x = coefficients, y = betas)) +
  geom_point(color = "brown", size = 2) +
  geom_text_repel(aes(label=p), size = 2.5) + 
  geom_errorbar(aes(ymin = betas - 2*standard_errors, ymax = betas + 2*standard_errors), color = "brown", width = 0.2) +
  xlab("Regression Variable") +
  ylab("Coefficient Value") +
  labs(title = "Significant Variables")
  theme(panel.background = element_rect(fill = "burlywood"),
        panel.grid.major=element_blank()
  )
```
---

## Mesuring the Impact of Between Game Events 

MATTHEW SHOW OUR COEFFCICENTS OVER THE SEASONS

---
## Flexible Modeling Techniques 

GRACE TALK about the modeling techniques we tried

--
## Flexible Modeling Techniques 

GRACE TALK about the modeling techniques we tried

--
How Can Teams Use This Information?

--
Future Work




