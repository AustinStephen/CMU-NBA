---
title: "<span style='font-size: 70px'>Measuring and Predicting Player Fatigue in the NBA </style>"
author: "<span style='font-size: 35px'>Austin Stephen, Matthew Yep and Grace Fain </style>"
date: "<span style='font-size: 35px'> 7/13/2021 </style>"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    
---
<style type="text/css">

h1.title {
  font-size: 10px;
}

</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  cache = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.show = TRUE,
  fig.width = 9, 
  fig.height=3.5,
  fig.retina = 3,
  out.width = "100%"
                      )
library(readr)
library(dplyr)
library(tidyverse)
library(gt)
library(xaringanthemer)
library(teamcolors)
library(usmap)
library(ggplot2)
library(maps)
library(mapdata)
library(airball)
 
```

```{r xaringan-themer, include=FALSE, warning=FALSE }

visitors <- read_csv("/Users/matthewyep/Desktop/Carnegie Mellon/CMU-NBA/data/visitors.csv")
data1415 <- read_csv("/Users/matthewyep/Desktop/Carnegie Mellon/CMU-NBA/data/regseason1415.csv")
style_mono_accent(base_color = "#cc002c",
  white_color = "#e6e6e6",
  background_color = "#b3b3b3",
  base_font_size = "28px"
  )
```

## Why fatigue?

- Optimized Performance  

- Injury Prevention   

???
1. Add source that found as players get more tired performance worsens in basketball.
Add source that talks about injury links to fatigue 
Add a source that 

---

## The Plan

1. Measure player fatigue  
  
2. Build a model that can be used to predict the impact of fatigue on a given game or multi-game sequence.  


???
Identify a proxy for fatigue and link it to in game performance.
This model can used by teams to examine their roster and match-ups and gain insights into 
how differnt factors are influencing their teams performance

---

## Measuring player fatigue

- Cannot use direct measures  
  
- Identify a proxy

???
To be more concrete on what we mean by fatigue: 
"the decline in objective performance measures derived from the capacity 
of the nervous system and contractile properties of muscles over time"

In a perfect world we would directly measure an NBA players internal homeostasis
either with hematological or with sensors that measure heart rate. Howoever, 
players cannot wear heart rate monitors or tracking equipment in games and we 
certainly don't have data about in/post-game blood samples so we need a proxy 
to measure how fatigued a player was by in game events.


---

## Proxy for Fatigue

- In game distance  

- Between game distance

???
We are examining two major sources for player fatigue.
1. The distance and speed at which they travel in game. 
We started by looking to validate this as proxy for player exertion in a given game.

2. The characteristics of their travel between games including days of rest,
distance traveled and time zone changes.


---

## In-Game Distance Data  

```{r, out.height= "100%"}
 tracking_player <- read_csv(
   "data/in_game_distance_data/tracking_by_player_season_daily_2018_19.csv")

tracking_player %>%
  ggplot(aes(x=dist_miles, y=avg_speed)) +
  geom_point()

 # tracking_player %>%
 #   select(c("player_name","date","min", "dist_miles","dist_miles_off", "dist_miles_def",
 #            "avg_speed","avg_speed_off","avg_speed_def")) %>%
 #   rename("Name" = player_name,
 #          "Distance (mi)" = dist_miles,
 #          "Distance Offense"  = dist_miles_off,
 #          "Distance Defense" = dist_miles_def,
 #          "Average Speed (mph)" = avg_speed,
 #          "Average Speed Offense" = avg_speed_off,
 #          "Average Speed Defense" = avg_speed_def,
 #          "Date" = date,
 #          "Min" = min) %>%
 #   slice(1:5) %>%
 #   gt() %>%
 #   tab_header(
 #    title = md("**Distance By Player Individual Games**")
 #  ) %>%
 #  tab_source_note(md("data courtesy of nba.com and Second Spectrum")) %>%
 #  opt_table_outline( style = "solid", width = px(5), color = "darkgrey")

```


---

## In-Game Distance Data

```{r}
tracking_team <- read_csv(
  "data/in_game_distance_data/tracking_by_team_season_summaries_2013_to_20.csv")

 tracking_team %>%
   select(c("team_name","w","l", "dist_miles","dist_miles_off", "dist_miles_def",
            "avg_speed","avg_speed_off","avg_speed_def")) %>%
   rename("Team" = team_name,
          "Distance (mi)" = dist_miles,
          "Distance Offense"  = dist_miles_off,
          "Distance Defense" = dist_miles_def,
          "Average Speed (mph)" = avg_speed,
          "Average Speed Offense" = avg_speed_off,
          "Average Speed Defense" = avg_speed_def) %>%
   slice(1:5) %>%
   gt() %>%
   tab_header(
    title = md("**Season Distance By Team**")
  ) %>%
  tab_source_note(md("data courtesy of nba.com and Second Spectrum")) %>%
  opt_table_outline( style = "solid", width = px(5), color = "darkgrey")
```

---
???
Insert table showing how it is structured

---

## Progress with in-game data 

???
Go through progress with in game data

---

## Progress with in-game data 2

???
Go through progress with in game data

---
# GRACE ADD HERE 

```{r load in data, include=FALSE}
library(tidyverse)
library(dplyr)
library(nbastatR)
library(NBAr)
library(tidyr)
library(knitr)
density_drives_2014_15 <- read.csv("./data1/density_distance_drives_tracking/_density_drives_distance_daily_2014_15.csv")
```

```{r table, echo = FALSE}
density_drives_2014_15 %>%
  kable()
knitr::kable(head(density_drives_2014_15), format = 'html', table.attr = "style='height:20%;'")

```

```{r drives_pts_pct, echo=FALSE}
##ATL
b2b_2014_ATL <- density_drives_2014_15 %>%
  filter(B2B.2nd == "Yes") %>%
  filter(drives > 0) %>%
  group_by(player_id) %>%
  filter(team_abbreviation == "ATL")

other_2014_ATL <- density_drives_2014_15 %>%
  filter(B2B.2nd == "No") %>%
  filter(drives > 0) %>%
  group_by(player_id) %>%
  filter(team_abbreviation == "ATL")

notB2b_2014_ATL <- aggregate(other_2014_ATL$drive_pts_pct / nrow(other_2014_ATL), list(other_2014_ATL$player_name), FUN=sum, na.rm = TRUE)

B2b_2014_ATL <-aggregate(b2b_2014_ATL$drive_pts_pct / nrow(b2b_2014_ATL), list(b2b_2014_ATL$player_name), FUN=sum, na.rm = TRUE)

drive_pct_2014_ATL <- merge(B2b_2014_ATL, notB2b_2014_ATL, by = "Group.1") %>%
  rename("2nd_B2B_game" = x.x, "not_2nd_B2B" = x.y)

drive_2014_ATL_long <- drive_pct_2014_ATL %>%
  gather("Stat", "Value", -Group.1)

ggplot(drive_2014_ATL_long, aes(x = Group.1, y = Value, fill = Stat)) +
  geom_bar(stat = "Identity", position = "dodge") +
  theme_bw() +
  ggtitle("Atlanta Hawks") +
  xlab("Players") +
  ylab("avg drive_pts_percent")

## GSW
b2b_2014_GSW <- density_drives_2014_15 %>%
  filter(B2B.2nd == "Yes") %>%
  filter(drives > 0) %>%
  group_by(player_id) %>%
  filter(team_abbreviation == "GSW")

other_2014_GSW <- density_drives_2014_15 %>%
  filter(B2B.2nd == "No") %>%
  filter(drives > 0) %>%
  group_by(player_id) %>%
  filter(team_abbreviation == "GSW")

notB2b_2014_GSW <- aggregate(other_2014_GSW$drive_pts_pct / nrow(other_2014_GSW), list(other_2014_GSW$player_name), FUN=sum, na.rm = TRUE)

b2b_2014_GSW <-aggregate(b2b_2014_GSW$drive_pts_pct / nrow(b2b_2014_GSW), list(b2b_2014_GSW$player_name), FUN=sum, na.rm = TRUE)

drive_pct_2014_GSW <- merge(b2b_2014_GSW, notB2b_2014_GSW, by = "Group.1") %>%
  rename("2nd_B2B_game" = x.x, "not_2nd_B2B" = x.y)

drive_2014_GSW_long <- drive_pct_2014_GSW %>%
  gather("Stat", "Value", -Group.1)

ggplot(drive_2014_GSW_long, aes(x = Group.1, y = Value, fill = Stat)) +
  geom_bar(stat = "Identity", position = "dodge") +
  theme_bw() +
  ggtitle("Golden State Warriors") +
  xlab("Players") +
  ylab("avg drive_pts_percent")

##DAL
b2b_2014_DAL <- density_drives_2014_15 %>%
  filter(B2B.2nd == "Yes") %>%
  filter(drives > 0) %>%
  group_by(player_id) %>%
  filter(team_abbreviation == "DAL")

other_2014_DAL <- density_drives_2014_15 %>%
  filter(B2B.2nd == "No") %>%
  filter(drives > 0) %>%
  group_by(player_id) %>%
  filter(team_abbreviation == "DAL")

notB2b_2014_DAL <- aggregate(other_2014_DAL$drive_pts_pct / nrow(other_2014_DAL), list(other_2014_DAL$player_name), FUN=sum, na.rm = TRUE)

b2b_2014_DAL <-aggregate(b2b_2014_DAL$drive_pts_pct / nrow(b2b_2014_DAL), list(b2b_2014_DAL$player_name), FUN=sum, na.rm = TRUE)

drive_pct_2014_DAL <- merge(b2b_2014_DAL, notB2b_2014_DAL, by = "Group.1") %>%
  rename("2nd_B2B_game" = x.x, "not_2nd_B2B" = x.y)

drive_2014_DAL_long <- drive_pct_2014_DAL %>%
  gather("Stat", "Value", -Group.1)

ggplot(drive_2014_DAL_long, aes(x = Group.1, y = Value, fill = Stat)) +
  geom_bar(stat = "Identity", position = "dodge") +
  theme_bw() +
  ggtitle("Dallas Mavericks") +
  xlab("Players") +
  ylab("avg drive_pts_percent")

## CHI
b2b_2014_CHI <- density_drives_2014_15 %>%
  filter(B2B.2nd == "Yes") %>%
  filter(drives > 0) %>%
  group_by(player_id) %>%
  filter(team_abbreviation == "CHI")

other_2014_CHI <- density_drives_2014_15 %>%
  filter(B2B.2nd == "No") %>%
  filter(drives > 0) %>%
  group_by(player_id) %>%
  filter(team_abbreviation == "CHI")

notB2b_2014_CHI <- aggregate(other_2014_CHI$drive_pts_pct / nrow(other_2014_CHI), list(other_2014_CHI$player_name), FUN=sum, na.rm = TRUE)

b2b_2014_CHI <-aggregate(b2b_2014_CHI$drive_pts_pct / nrow(b2b_2014_CHI), list(b2b_2014_CHI$player_name), FUN=sum, na.rm = TRUE)

drive_pct_2014_CHI <- merge(b2b_2014_CHI, notB2b_2014_CHI, by = "Group.1") %>%
  rename("2nd_B2B_game" = x.x, "not_2nd_B2B" = x.y)

drive_2014_CHI_long <- drive_pct_2014_CHI %>%
  gather("Stat", "Value", -Group.1)

ggplot(drive_2014_CHI_long, aes(x = Group.1, y = Value, fill = Stat)) +
  geom_bar(stat = "Identity", position = "dodge") +
  theme_bw()  +
  ggtitle("Chicago Bulls") +
  xlab("Players") +
  ylab("avg drive_pts_percent")

```
---
# MATTHEW ADD HERE
Grace add your progress with between game data

### How does travel between games affect team performance?
```{r Map, echo=FALSE, fig.height= 7, fig.width=11}
cumulative_distance1415 <- data1415 %>%
  group_by(Team) %>%
  summarise_at(vars(Distance),
               list(total_distance_traveled = sum))

home_stadium_coords <- data1415 %>%
  filter(Visitor == FALSE) %>%
  select(Team, Latitude, Longitude) %>%
  distinct()

coords_and_distance <- merge(x = cumulative_distance1415,  y= home_stadium_coords,
                             by = "Team")

usa <- map_data("usa")
states <- map_data("state")
ggplot() + geom_polygon(data = states, aes(x=long, y = lat, fill = region, group = group), fill = "azure2", color = "gray") + 
  coord_fixed(1.3) +
  geom_point(data = coords_and_distance, aes(x=Longitude, y=Latitude,  
                                             size = total_distance_traveled),
             alpha = 0.8) + 
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
        axis.text.y=element_blank(),axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.background=element_blank(),panel.border=element_blank(),panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),plot.background=element_blank(),
        legend.position = "top")
```

---

### The Cavaliers cross far less timezones than the coastal teams
```{r Flight Paths, echo=FALSE, fig.height = 6, fig.width=12}

datos <- nba_travel(start_season = 2015, end_season = 2015)


nba_travel_plot(data = datos,
                season = 2015,
                team = c("Portland Trail Blazers","Denver Nuggets", "Cleveland Cavaliers", "Boston Celtics"),
                city_color = "white",
                plot_background_fill = "black",
                land_color = "gray",
                caption_color = "lightblue",
                ncolumns = 2)

```

---

# The Travel Data
```{r Matthew Data, echo= FALSE, fig.height = 6, fig.width=12}
data_example <- together %>%
  select(c(Date, Team, Opponent, Visitor, Distance, Rest, shift, b2b_2nd, traveling_west))

knitr::kable(head(data_example), format = 'html')
```

---

### Distance doesn't have a significant effect on the score difference
```{r Linear Model, echo=FALSE, fig.align='center', out.width='30%'}
travel_visitors_lm <- lm(score_diff ~ win_percent_diff + Distance + Rest
                         + hours_shift + three_in_four + b2b_2nd, 
                  data = visitors)

summary(travel_visitors_lm)

```

---

#Next Steps
- Find stronger proxies to account for difference in team vs opponent strength
- Logistic regression predicting win or loss instead of score difference
- Test the models on Bubble and 2021 data (where there was none of significantly less travel)

