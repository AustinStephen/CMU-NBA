---
title: "<span style='font-size: 70px'>Measuring and Predicting Player Fatigue in the NBA </style>"
author: "<span style='font-size: 35px'>Austin Stephen, Matthew Yep and Grace Fain </style>"
date: "<span style='font-size: 35px'> 7/13/2021 </style>"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  cache = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.show = TRUE,
  fig.width = 9, 
  fig.height=3.5,
  fig.retina = 3,
  out.width = "100%"
                      )
library(readr)
library(dplyr)
library(tidyverse)
library(gt)
library(xaringanthemer)
library(teamcolors)
library(usmap)
library(ggplot2)
library(maps)
library(mapdata)
library(airball)
library(gridExtra)
 
```

```{r xaringan-themer, include=FALSE, warning=FALSE }

visitors <- read_csv("./matthew_data/visitors.csv")
data1415 <- read_csv("./matthew_data/regseason1415.csv")
style_mono_accent(base_color = "#cc002c",
  white_color = "#e6e6e6",
  background_color = "#b3b3b3",
  base_font_size = "28px"
  )
```

## Why fatigue?

- Optimized Performance  

- Injury Prevention   

???
1. Add source that found as players get more tired performance worsens in basketball.
Add source that talks about injury links to fatigue 
Add a source that 

---

## The Plan

1. Measure player fatigue  
  
2. Build a model that can be used to predict the impact of fatigue on a given game or multi-game sequence.  


???
Identify a proxy for fatigue and link it to in game performance.
This model can used by teams to examine their roster and match-ups and gain insights into 
how differnt factors are influencing their teams performance

---

## Measuring player fatigue

- Cannot use direct measures  
  
- Identify a proxy

???
To be more concrete on what we mean by fatigue: 
"the decline in objective performance measures derived from the capacity 
of the nervous system and contractile properties of muscles over time"

In a perfect world we would directly measure an NBA players internal homeostasis
either with hematological or with sensors that measure heart rate. Howoever, 
players cannot wear heart rate monitors or tracking equipment in games and we 
certainly don't have data about in/post-game blood samples so we need a proxy 
to measure how fatigued a player was by in game events.


---

## Proxy for Fatigue

- In game distance  

- Between game distance

???
We are examining two major sources for player fatigue.
1. The distance and speed at which they travel in game. 
We started by looking to validate this as proxy for player exertion in a given game.

2. The characteristics of their travel between games including days of rest,
distance traveled and time zone changes.


---

## In-Game Distance Data  

```{r, out.height= "100%"}
 tracking_player <- read_csv(
   "data/in_game_distance_data/tracking_by_player_season_daily_2018_19.csv")

tracking_player %>%
  ggplot(aes(x=dist_miles, y=avg_speed)) +
  geom_point()

 # tracking_player %>%
 #   select(c("player_name","date","min", "dist_miles","dist_miles_off", "dist_miles_def",
 #            "avg_speed","avg_speed_off","avg_speed_def")) %>%
 #   rename("Name" = player_name,
 #          "Distance (mi)" = dist_miles,
 #          "Distance Offense"  = dist_miles_off,
 #          "Distance Defense" = dist_miles_def,
 #          "Average Speed (mph)" = avg_speed,
 #          "Average Speed Offense" = avg_speed_off,
 #          "Average Speed Defense" = avg_speed_def,
 #          "Date" = date,
 #          "Min" = min) %>%
 #   slice(1:5) %>%
 #   gt() %>%
 #   tab_header(
 #    title = md("**Distance By Player Individual Games**")
 #  ) %>%
 #  tab_source_note(md("data courtesy of nba.com and Second Spectrum")) %>%
 #  opt_table_outline( style = "solid", width = px(5), color = "darkgrey")

```


---

## In-Game Distance Data

```{r}
tracking_team <- read_csv(
  "data/in_game_distance_data/tracking_by_team_season_summaries_2013_to_20.csv")

 tracking_team %>%
   select(c("team_name","w","l", "dist_miles","dist_miles_off", "dist_miles_def",
            "avg_speed","avg_speed_off","avg_speed_def")) %>%
   rename("Team" = team_name,
          "Distance (mi)" = dist_miles,
          "Distance Offense"  = dist_miles_off,
          "Distance Defense" = dist_miles_def,
          "Average Speed (mph)" = avg_speed,
          "Average Speed Offense" = avg_speed_off,
          "Average Speed Defense" = avg_speed_def) %>%
   slice(1:5) %>%
   gt() %>%
   tab_header(
    title = md("**Season Distance By Team**")
  ) %>%
  tab_source_note(md("data courtesy of nba.com and Second Spectrum")) %>%
  opt_table_outline( style = "solid", width = px(5), color = "darkgrey")
```

---
???
Insert table showing how it is structured

---

## Progress with in-game data 

???
Go through progress with in game data

---

## Progress with in-game data 2

???
Go through progress with in game data

---
### Drives and schedule density data 

```{r load in data, include=FALSE}
density_drives_2014_15 <- read.csv("./data1/density_distance_drives_tracking/_density_drives_distance_daily_2014_15.csv")

density_drives_2018_19 <- read.csv("./data1/density_distance_drives_tracking/_density_drives_distance_daily_2018_19.csv")
```

```{r table}

density_drives_2014_15 %>%
   select(c("team_abbreviation","player_name","w","l", "drives", "drive_pts", "drive_pts_pct", "drive_passes_pct", "drive_tov_pct", "dist_miles", "B2B.2nd")) %>%
   rename("Team" = team_abbreviation,
          "Player" = player_name,
          "Distance (mi)" = dist_miles,
          "# of Drives" = drives,
          "2nd of a B2B" = B2B.2nd,
          "points per drive" = drive_pts_pct,
          "passes per drive" = drive_passes_pct,
          "turnovers per drive" = drive_tov_pct) %>%
   slice(5:10) %>%
   gt() %>%
   tab_header(
    title = md("**Drives, Distance, and Schedule Density by Player**")
  ) %>%
  tab_source_note(md("data courtesy of nba.com, Second Spectrum, and the airball r package")) %>%
  opt_table_outline( style = "solid", width = px(5), color = "darkgrey")

```

---
### Average Points Per Drive and Back-To-Back Games
```{r drives_pts_pct, echo=FALSE}
##ATL
b2b_2014_ATL <- density_drives_2014_15 %>%
  filter(B2B.2nd == "Yes") %>%
  filter(drives > 0) %>%
  group_by(player_id) %>%
  filter(team_abbreviation == "ATL")

other_2014_ATL <- density_drives_2014_15 %>%
  filter(B2B.2nd == "No") %>%
  filter(drives > 0) %>%
  group_by(player_id) %>%
  filter(team_abbreviation == "ATL")

notB2b_2014_ATL <- aggregate(other_2014_ATL$drive_pts_pct / nrow(other_2014_ATL), list(other_2014_ATL$player_name), FUN=sum, na.rm = TRUE)

B2b_2014_ATL <-aggregate(b2b_2014_ATL$drive_pts_pct / nrow(b2b_2014_ATL), list(b2b_2014_ATL$player_name), FUN=sum, na.rm = TRUE)

drive_pct_2014_ATL <- merge(B2b_2014_ATL, notB2b_2014_ATL, by = "Group.1") %>%
  rename("2nd_B2B_game" = x.x, "not_2nd_B2B" = x.y)

drive_2014_ATL_long <- drive_pct_2014_ATL %>%
  gather("Stat", "Value", -Group.1)

p1 <- ggplot(drive_2014_ATL_long, aes(x = Group.1, y = Value, fill = Stat)) +
  geom_bar(stat = "Identity", position = "dodge") +
  theme_bw() +
  ggtitle("Atlanta Hawks") +
  xlab("Players") +
  ylab("avg pts per drive") +
  scale_fill_manual("Stat", values = c("not_2nd_B2B" = "black", "2nd_B2B_game" = "skyblue")) +
  theme(axis.text.x = element_text(size=5, angle=45, hjust = 1))

## GSW
b2b_2014_GSW <- density_drives_2014_15 %>%
  filter(B2B.2nd == "Yes") %>%
  filter(drives > 0) %>%
  group_by(player_id) %>%
  filter(team_abbreviation == "GSW")

other_2014_GSW <- density_drives_2014_15 %>%
  filter(B2B.2nd == "No") %>%
  filter(drives > 0) %>%
  group_by(player_id) %>%
  filter(team_abbreviation == "GSW")

notB2b_2014_GSW <- aggregate(other_2014_GSW$drive_pts_pct / nrow(other_2014_GSW), list(other_2014_GSW$player_name), FUN=sum, na.rm = TRUE)

b2b_2014_GSW <-aggregate(b2b_2014_GSW$drive_pts_pct / nrow(b2b_2014_GSW), list(b2b_2014_GSW$player_name), FUN=sum, na.rm = TRUE)

drive_pct_2014_GSW <- merge(b2b_2014_GSW, notB2b_2014_GSW, by = "Group.1") %>%
  rename("2nd_B2B_game" = x.x, "not_2nd_B2B" = x.y)

drive_2014_GSW_long <- drive_pct_2014_GSW %>%
  gather("Stat", "Value", -Group.1)

p2 <- ggplot(drive_2014_GSW_long, aes(x = Group.1, y = Value, fill = Stat)) +
  geom_bar(stat = "Identity", position = "dodge") +
  theme_bw() +
  ggtitle("Golden State Warriors") +
  xlab("Players") +
  ylab("avg pts per drive") +
  scale_fill_manual("Stat", values = c("not_2nd_B2B" = "black", "2nd_B2B_game" = "skyblue")) +
  theme(axis.text.x = element_text(size=5, angle=45, hjust = 1))

##MIN
b2b_2014_MIN <- density_drives_2014_15 %>%
  filter(B2B.2nd == "Yes") %>%
  filter(drives > 0) %>%
  group_by(player_id) %>%
  filter(team_abbreviation == "MIN")

other_2014_MIN <- density_drives_2014_15 %>%
  filter(B2B.2nd == "No") %>%
  filter(drives > 0) %>%
  group_by(player_id) %>%
  filter(team_abbreviation == "MIN")

notB2b_2014_MIN <- aggregate(other_2014_MIN$drive_pts_pct / nrow(other_2014_MIN), list(other_2014_MIN$player_name), FUN=sum, na.rm = TRUE)

b2b_2014_MIN <-aggregate(b2b_2014_MIN$drive_pts_pct / nrow(b2b_2014_MIN), list(b2b_2014_MIN$player_name), FUN=sum, na.rm = TRUE)

drive_pct_2014_MIN <- merge(b2b_2014_MIN, notB2b_2014_MIN, by = "Group.1") %>%
  rename("2nd_B2B_game" = x.x, "not_2nd_B2B" = x.y)

drive_2014_MIN_long <- drive_pct_2014_MIN %>%
  gather("Stat", "Value", -Group.1)

p3 <- ggplot(drive_2014_MIN_long, aes(x = Group.1, y = Value, fill = Stat)) +
  geom_bar(stat = "Identity", position = "dodge") +
  theme_bw() +
  ggtitle("Minnesota Timberwolves") +
  xlab("Players") +
  ylab("avg pts per drive") +
  scale_fill_manual("Stat", values = c("not_2nd_B2B" = "black", "2nd_B2B_game" = "skyblue")) +
  theme(axis.text.x = element_text(size=5, angle=45, hjust = 1))

## NYK
b2b_2014_NYK <- density_drives_2014_15 %>%
  filter(B2B.2nd == "Yes") %>%
  filter(drives > 0) %>%
  group_by(player_id) %>%
  filter(team_abbreviation == "NYK") %>%
  arrange(drive_pts_pct)

other_2014_NYK <- density_drives_2014_15 %>%
  filter(B2B.2nd == "No") %>%
  filter(drives > 0) %>%
  group_by(player_id) %>%
  filter(team_abbreviation == "NYK") %>%
  arrange(drive_pts_pct)

notB2b_2014_NYK <- aggregate(other_2014_NYK$drive_pts_pct / nrow(other_2014_NYK), list(other_2014_NYK$player_name), FUN=sum, na.rm = TRUE)

b2b_2014_NYK <-aggregate(b2b_2014_NYK$drive_pts_pct / nrow(b2b_2014_NYK), list(b2b_2014_NYK$player_name), FUN=sum, na.rm = TRUE)

drive_pct_2014_NYK <- merge(b2b_2014_NYK, notB2b_2014_NYK, by = "Group.1") %>%
  rename("2nd_B2B_game" = x.x, "not_2nd_B2B" = x.y)

drive_2014_NYK_long <- drive_pct_2014_NYK %>%
  gather("Stat", "Value", -Group.1)
  
p4 <- ggplot(drive_2014_NYK_long, aes(x = Group.1, y = Value, fill = Stat)) +
  geom_bar(stat = "Identity", position = "dodge") +
  theme_bw()  +
  ggtitle("New York Knicks") +
  xlab("Players") +
  ylab("avg pts per drive") +
  scale_fill_manual("Stat", values = c("not_2nd_B2B" = "black", "2nd_B2B_game" = "skyblue")) +
  theme(axis.text.x = element_text(size=5, angle=45, hjust = 1))

grid.arrange(p2, p3, p1, p4, nrow = 2, ncol = 2)
```

---
### Over half of the NBA teams score less points per drive in the second game of a back-to-back
```{r team pts pct, echo = FALSE}

##ALL
b2b_2014_ALL <- density_drives_2014_15 %>%
  filter(B2B.2nd == "Yes") %>%
  filter(drives > 0) %>%
  group_by(team_abbreviation) 

other_2014_ALL <- density_drives_2014_15 %>%
  filter(B2B.2nd == "No") %>%
  filter(drives > 0) %>%
  group_by(team_abbreviation) 

notB2b_2014_ALL_pts <- aggregate(other_2014_ALL$drive_pts_pct / nrow(other_2014_ALL), list(other_2014_ALL$team_abbreviation), FUN=sum, na.rm = TRUE)

B2b_2014_ALL_pts <-aggregate(b2b_2014_ALL$drive_pts_pct / nrow(b2b_2014_ALL), list(b2b_2014_ALL$team_abbreviation), FUN=sum, na.rm = TRUE)

drive_pct_2014_ALL_pts <- merge(B2b_2014_ALL_pts, notB2b_2014_ALL_pts, by = "Group.1") %>%
  rename("2nd_B2B_game" = x.x, "not_2nd_B2B" = x.y)

drive_2014_ALL_long_pts <- drive_pct_2014_ALL_pts %>%
  gather("Stat", "Value", -Group.1) 

ggplot(drive_2014_ALL_long_pts, aes(x = Group.1, y = Value, fill = Stat)) +
  geom_bar(stat = "Identity", position = "dodge") +
  theme_bw() +
  ggtitle("Average points per drive for each NBA team") +
  xlab("Team") +
  ylab("avg points per drive") +
  scale_fill_manual("Stat", values = c("not_2nd_B2B" = "black", "2nd_B2B_game" = "skyblue")) +
  theme(axis.text.x = element_text(size=7, angle=45, hjust = 1))



```
---

### Average number of passes out of drives and back-to-back games
```{r drive and pass, echo = FALSE}
##ATL
b2b_2014_ATL <- density_drives_2014_15 %>%
  filter(B2B.2nd == "Yes") %>%
  filter(drives > 0) %>%
  group_by(player_id) %>%
  filter(team_abbreviation == "ATL")

other_2014_ATL <- density_drives_2014_15 %>%
  filter(B2B.2nd == "No") %>%
  filter(drives > 0) %>%
  group_by(player_id) %>%
  filter(team_abbreviation == "ATL")

notB2b_2014_ATL_pass <- aggregate(other_2014_ATL$drive_passes_pct / nrow(other_2014_ATL), list(other_2014_ATL$player_name), FUN=sum, na.rm = TRUE)

B2b_2014_ATL_pass <-aggregate(b2b_2014_ATL$drive_passes_pct / nrow(b2b_2014_ATL), list(b2b_2014_ATL$player_name), FUN=sum, na.rm = TRUE)

drive_pct_2014_ATL_pass <- merge(B2b_2014_ATL_pass, notB2b_2014_ATL_pass, by = "Group.1") %>%
  rename("2nd_B2B_game" = x.x, "not_2nd_B2B" = x.y)

drive_2014_ATL_long_pass <- drive_pct_2014_ATL_pass %>%
  gather("Stat", "Value", -Group.1)

p1 <- ggplot(drive_2014_ATL_long_pass, aes(x = Group.1, y = Value, fill = Stat)) +
  geom_bar(stat = "Identity", position = "dodge") +
  theme_bw() +
  ggtitle("Atlanta Hawks") +
  xlab("Players") +
  ylab("avg passes per drive") +
  scale_fill_manual("Stat", values = c("not_2nd_B2B" = "black", "2nd_B2B_game" = "skyblue")) +
  theme(axis.text.x = element_text(size=5, angle=45, hjust = 1))

## GSW
b2b_2014_GSW <- density_drives_2014_15 %>%
  filter(B2B.2nd == "Yes") %>%
  filter(drives > 0) %>%
  group_by(player_id) %>%
  filter(team_abbreviation == "GSW")

other_2014_GSW <- density_drives_2014_15 %>%
  filter(B2B.2nd == "No") %>%
  filter(drives > 0) %>%
  group_by(player_id) %>%
  filter(team_abbreviation == "GSW")

notB2b_2014_GSW_pass <- aggregate(other_2014_GSW$drive_passes_pct / nrow(other_2014_GSW), list(other_2014_GSW$player_name), FUN=sum, na.rm = TRUE)

b2b_2014_GSW_pass <-aggregate(b2b_2014_GSW$drive_passes_pct/ nrow(b2b_2014_GSW), list(b2b_2014_GSW$player_name), FUN=sum, na.rm = TRUE)

drive_pct_2014_GSW_pass <- merge(b2b_2014_GSW_pass, notB2b_2014_GSW_pass, by = "Group.1") %>%
  rename("2nd_B2B_game" = x.x, "not_2nd_B2B" = x.y)

drive_2014_GSW_long_pass <- drive_pct_2014_GSW_pass %>%
  gather("Stat", "Value", -Group.1)

p2 <- ggplot(drive_2014_GSW_long_pass, aes(x = Group.1, y = Value, fill = Stat)) +
  geom_bar(stat = "Identity", position = "dodge") +
  theme_bw() +
  ggtitle("Golden State Warriors") +
  xlab("Players") +
  ylab("avg passes per drive") +
  scale_fill_manual("Stat", values = c("not_2nd_B2B" = "black", "2nd_B2B_game" = "skyblue")) +
  theme(axis.text.x = element_text(size=5, angle=45, hjust = 1))

##MIN
b2b_2014_MIN <- density_drives_2014_15 %>%
  filter(B2B.2nd == "Yes") %>%
  filter(drives > 0) %>%
  group_by(player_id) %>%
  filter(team_abbreviation == "MIN")

other_2014_MIN <- density_drives_2014_15 %>%
  filter(B2B.2nd == "No") %>%
  filter(drives > 0) %>%
  group_by(player_id) %>%
  filter(team_abbreviation == "MIN")

notB2b_2014_MIN_pass <- aggregate(other_2014_MIN$drive_passes_pct / nrow(other_2014_MIN), list(other_2014_MIN$player_name), FUN=sum, na.rm = TRUE)

b2b_2014_MIN_pass <-aggregate(b2b_2014_MIN$drive_passes_pct / nrow(b2b_2014_MIN), list(b2b_2014_MIN$player_name), FUN=sum, na.rm = TRUE)

drive_pct_2014_MIN_pass <- merge(b2b_2014_MIN_pass, notB2b_2014_MIN_pass, by = "Group.1") %>%
  rename("2nd_B2B_game" = x.x, "not_2nd_B2B" = x.y)

drive_2014_MIN_long_pass <- drive_pct_2014_MIN_pass %>%
  gather("Stat", "Value", -Group.1)

p3 <- ggplot(drive_2014_MIN_long_pass, aes(x = Group.1, y = Value, fill = Stat)) +
  geom_bar(stat = "Identity", position = "dodge") +
  theme_bw() +
  ggtitle("Minnesota Timberwolves") +
  xlab("Players") +
  ylab("avg passes per drive") +
  scale_fill_manual("Stat", values = c("not_2nd_B2B" = "black", "2nd_B2B_game" = "skyblue")) +
  theme(axis.text.x = element_text(size=5, angle=45, hjust = 1))

## NYK
b2b_2014_NYK <- density_drives_2014_15 %>%
  filter(B2B.2nd == "Yes") %>%
  filter(drives > 0) %>%
  group_by(player_id) %>%
  filter(team_abbreviation == "NYK") 

other_2014_NYK <- density_drives_2014_15 %>%
  filter(B2B.2nd == "No") %>%
  filter(drives > 0) %>%
  group_by(player_id) %>%
  filter(team_abbreviation == "NYK") 

notB2b_2014_NYK_pass <- aggregate((other_2014_NYK$drive_passes_pct) / nrow(other_2014_NYK), list(other_2014_NYK$player_name), FUN=sum, na.rm = TRUE)

b2b_2014_NYK_pass <-aggregate((b2b_2014_NYK$drive_passes_pct) / nrow(b2b_2014_NYK), list(b2b_2014_NYK$player_name), FUN=sum, na.rm = TRUE)

drive_pct_2014_NYK_pass <- merge(b2b_2014_NYK_pass, notB2b_2014_NYK_pass, by = "Group.1") %>%
  rename("2nd_B2B_game" = x.x, "not_2nd_B2B" = x.y)

drive_2014_NYK_long_pass <- drive_pct_2014_NYK_pass %>%
  gather("Stat", "Value", -Group.1)
  
p4 <- ggplot(drive_2014_NYK_long_pass, aes(x = Group.1, y = Value, fill = Stat)) +
  geom_bar(stat = "Identity", position = "dodge") +
  theme_bw()  +
  ggtitle("New York Knicks") +
  xlab("Players") +
  ylab("avg passes per drive") +
  scale_fill_manual("Stat", values = c("not_2nd_B2B" = "black", "2nd_B2B_game" = "skyblue")) +
  theme(axis.text.x = element_text(size=5, angle=45, hjust = 1))


grid.arrange(p2, p3, p1, p4, nrow = 2, ncol = 2)

```

---
### Over half of the NBA teams pass out of drives more in the second game of a back-to-back
```{r 2018-2019 season, echo = FALSE}

##ALL
b2b_2014_ALL <- density_drives_2014_15 %>%
  filter(B2B.2nd == "Yes") %>%
  filter(drives > 0) %>%
  group_by(team_abbreviation) 

other_2014_ALL <- density_drives_2014_15 %>%
  filter(B2B.2nd == "No") %>%
  filter(drives > 0) %>%
  group_by(team_abbreviation) 

notB2b_2014_ALL_pass <- aggregate(other_2014_ALL$drive_passes_pct / nrow(other_2014_ALL), list(other_2014_ALL$team_abbreviation), FUN=sum, na.rm = TRUE)

B2b_2014_ALL_pass <-aggregate(b2b_2014_ALL$drive_passes_pct / nrow(b2b_2014_ALL), list(b2b_2014_ALL$team_abbreviation), FUN=sum, na.rm = TRUE)

drive_pct_2014_ALL_pass <- merge(B2b_2014_ALL_pass, notB2b_2014_ALL_pass, by = "Group.1") %>%
  rename("2nd_B2B_game" = x.x, "not_2nd_B2B" = x.y)

drive_2014_ALL_long_pass <- drive_pct_2014_ALL_pass %>%
  gather("Stat", "Value", -Group.1) 

ggplot(drive_2014_ALL_long_pass, aes(x = Group.1, y = Value, fill = Stat)) +
  geom_bar(stat = "Identity", position = "dodge") +
  theme_bw() +
  ggtitle("Average percent of drives that are passed by each NBA team") +
  xlab("Team") +
  ylab("avg # of passes per drive") +
  scale_fill_manual("Stat", values = c("not_2nd_B2B" = "black", "2nd_B2B_game" = "skyblue")) +
  theme(axis.text.x = element_text(size=7, angle=45, hjust = 1))


```

---
### Less than half of the NBA teams turnover the ball on drives more in the second game of a back-to-back game
```{r drives tov, echo = FALSE}
##ALL
b2b_2014_ALL <- density_drives_2014_15 %>%
  filter(B2B.2nd == "Yes") %>%
  filter(drives > 0) %>%
  group_by(team_abbreviation) 

other_2014_ALL <- density_drives_2014_15 %>%
  filter(B2B.2nd == "No") %>%
  filter(drives > 0) %>%
  group_by(team_abbreviation) 

notB2b_2014_ALL_tov <- aggregate(other_2014_ALL$drive_tov_pct / nrow(other_2014_ALL), list(other_2014_ALL$team_abbreviation), FUN=sum, na.rm = TRUE)

B2b_2014_ALL_tov <-aggregate(b2b_2014_ALL$drive_tov_pct / nrow(b2b_2014_ALL), list(b2b_2014_ALL$team_abbreviation), FUN=sum, na.rm = TRUE)

drive_pct_2014_ALL_tov <- merge(B2b_2014_ALL_tov, notB2b_2014_ALL_tov, by = "Group.1") %>%
  rename("2nd_B2B_game" = x.x, "not_2nd_B2B" = x.y)

drive_2014_ALL_long_tov <- drive_pct_2014_ALL_tov %>%
  gather("Stat", "Value", -Group.1) 

ggplot(drive_2014_ALL_long_tov, aes(x = Group.1, y = Value, fill = Stat)) +
  geom_bar(stat = "Identity", position = "dodge") +
  theme_bw() +
  ggtitle("Average percent of drives that are turned-over by each NBA team") +
  xlab("Team") +
  ylab("avg percent of turnovers per drive") +
  scale_fill_manual("Stat", values = c("not_2nd_B2B" = "black", "2nd_B2B_game" = "skyblue")) +
  theme(axis.text.x = element_text(size=7, angle=45, hjust = 1))
```

---
# MATTHEW ADD HERE
Grace add your progress with between game data

### How does travel between games affect team performance?
```{r Map, echo=FALSE, fig.height= 7, fig.width=11}
cumulative_distance1415 <- data1415 %>%
  group_by(Team) %>%
  summarise_at(vars(Distance),
               list(total_distance_traveled = sum))

home_stadium_coords <- data1415 %>%
  filter(Visitor == FALSE) %>%
  select(Team, Latitude, Longitude) %>%
  distinct()

coords_and_distance <- merge(x = cumulative_distance1415,  y= home_stadium_coords,
                             by = "Team")

usa <- map_data("usa")
states <- map_data("state")
ggplot() + geom_polygon(data = states, aes(x=long, y = lat, fill = region, group = group), fill = "azure2", color = "gray") + 
  coord_fixed(1.3) +
  geom_point(data = coords_and_distance, aes(x=Longitude, y=Latitude,  
                                             size = total_distance_traveled),
             alpha = 0.8) + 
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
        axis.text.y=element_blank(),axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.background=element_blank(),panel.border=element_blank(),panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),plot.background=element_blank(),
        legend.position = "top")
```

---

### The Cavaliers cross far less timezones than the coastal teams
```{r Flight Paths, echo=FALSE, fig.height = 6, fig.width=12}

datos <- nba_travel(start_season = 2015, end_season = 2015)


nba_travel_plot(data = datos,
                season = 2015,
                team = c("Portland Trail Blazers","Denver Nuggets", "Cleveland Cavaliers", "Boston Celtics"),
                city_color = "white",
                plot_background_fill = "black",
                land_color = "gray",
                caption_color = "lightblue",
                ncolumns = 2)

```

---

# The Travel Data
```{r Matthew Data, echo= FALSE, fig.height = 6, fig.width=12}
data_example <- visitors %>%
  select(c(Date, Team, Opponent, Visitor, Distance, Rest, shift, b2b_2nd, traveling_west))

knitr::kable(head(data_example), format = 'html')
```

---

### Distance doesn't have a significant effect on the score difference
```{r Linear Model, echo=FALSE, fig.align='center', out.width='30%'}
travel_visitors_lm <- lm(score_diff ~ win_percent_diff + Distance + Rest
                         + hours_shift + three_in_four + b2b_2nd, 
                  data = visitors)

summary(travel_visitors_lm)

```

---

#Next Steps
- Find stronger proxies to account for difference in team vs opponent strength
- Logistic regression predicting win or loss instead of score difference
- Test the models on Bubble and 2021 data (where there was none of significantly less travel)

